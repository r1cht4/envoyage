# Home node docker-compose.yml
# Run this on your HOME machine (PC/homeserver).
# The VPS gets its own docker-compose.vps.yml.
#
# Copy .env.example to .env and fill in your values before running.

services:

  controlplane:
    build: .
    ports:
      - "8080:8080"   # Management API
      - "9090:9090"   # xDS gRPC (reachable from VPS via WireGuard)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - ENVOYAGE_HOME_WG_IP=${ENVOYAGE_HOME_WG_IP:-envoy-home}
      - ENVOYAGE_HOME_ENVOY_PORT=${ENVOYAGE_HOME_ENVOY_PORT:-10000}
      - ENVOYAGE_XDS_ADDR=${ENVOYAGE_XDS_ADDR:-:9090}
      - ENVOYAGE_API_ADDR=${ENVOYAGE_API_ADDR:-:8080}
      - ENVOYAGE_HOME_NODE_ID=${ENVOYAGE_HOME_NODE_ID:-envoyage-envoy-home}
      - ENVOYAGE_VPS_NODE_ID=${ENVOYAGE_VPS_NODE_ID:-envoyage-envoy-vps}
    networks:
      - envoyage

  envoy-home:
    image: envoyproxy/envoy:v1.32-latest
    command: -c /etc/envoy/bootstrap.yaml --log-level info
    volumes:
      - ./envoy/bootstrap-home.yaml:/etc/envoy/bootstrap.yaml:ro
    ports:
      - "10000:10000"  # Home Envoy ingress (VPS routes WG traffic here)
      - "9901:9901"    # Envoy admin UI
    depends_on:
      - controlplane
    networks:
      - envoyage

  web-a:
    image: python:3.12-alpine
    command: >
      sh -c "echo 'Hello from upstream A' > /tmp/index.html &&
             python3 -m http.server 5678 --directory /tmp"
    labels:
      envoyage.enable: "true"
      envoyage.domain: "web.example.com"
      envoyage.port:   "5678"
    networks:
      - envoyage

  web-b:
    image: python:3.12-alpine
    command: >
      sh -c "echo 'Hello from upstream B' > /tmp/index.html &&
             python3 -m http.server 5678 --directory /tmp"
    networks:
      - envoyage

networks:
  envoyage:
    driver: bridge